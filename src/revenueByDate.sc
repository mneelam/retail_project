import org.apache.spark.SparkContext
import org.apache.spark.SparkConf

val conf= new SparkConf().setMaster("local").setAppName("revenueByDate")
val sc = new SparkContext(conf)
val orders = sc.textFile("file:///C:/Users/Mahesh/Desktop/data/retail_db/orders/part-00000")
val order_items= sc.textFile("file:///C:/Users/Mahesh/Desktop/data/retail_db/order_items/part-00000")

/* Setting up hadoop Binaries*/
System.setProperty("hadoop.home.dir", "C:/winutils/")

/* Filter the records from ORDERS table with status CLOSED and COMPLETE*/
val orders_filter= orders.filter(rec=> rec.split(",")(3)=="COMPLETE" || rec.split(",")(3)=="CLOSED")

//orders_filter.take(10).foreach(println)
/*
1,2013-07-25 00:00:00.0,11599,CLOSED
3,2013-07-25 00:00:00.0,12111,COMPLETE
4,2013-07-25 00:00:00.0,8827,CLOSED
5,2013-07-25 00:00:00.0,11318,COMPLETE
6,2013-07-25 00:00:00.0,7130,COMPLETE
7,2013-07-25 00:00:00.0,4530,COMPLETE
12,2013-07-25 00:00:00.0,1837,CLOSED
15,2013-07-25 00:00:00.0,2568,COMPLETE
17,2013-07-25 00:00:00.0,2667,COMPLETE
18,2013-07-25 00:00:00.0,1205,CLOSED
*/

val orders_map = orders_filter.map(rec=>(rec.split(",")(0).toInt,rec.split(",")(1)))

//orders_map.take(10).foreach(println)
/*
(1,2013-07-25 00:00:00.0)
(3,2013-07-25 00:00:00.0)
(4,2013-07-25 00:00:00.0)
(5,2013-07-25 00:00:00.0)
(6,2013-07-25 00:00:00.0)
(7,2013-07-25 00:00:00.0)
(12,2013-07-25 00:00:00.0)
(15,2013-07-25 00:00:00.0)
(17,2013-07-25 00:00:00.0)
(18,2013-07-25 00:00:00.0)
 */

val orditm_filter= order_items.map(rec=>(rec.split(",")(1).toInt,rec.split(",")(4).toDouble))
//orditm_filter.take(10).foreach(println)
/*(1,299.98)
(2,199.99)
(2,250.0)
(2,129.99)
(4,49.98)
(4,299.95)
(4,150.0)
(4,199.92)
(5,299.98)
(5,299.95)
*/

val orders_join= orders_map.join(orditm_filter)
//orders_join.take(10).foreach(println)
/*
(65722,(2014-05-23 00:00:00.0,119.98))
(65722,(2014-05-23 00:00:00.0,400.0))
(65722,(2014-05-23 00:00:00.0,399.98))
(65722,(2014-05-23 00:00:00.0,199.95))
(65722,(2014-05-23 00:00:00.0,199.98))
(23776,(2013-12-20 00:00:00.0,199.99))
(23776,(2013-12-20 00:00:00.0,129.99))
(34207,(2014-02-20 00:00:00.0,99.96))
(34207,(2014-02-20 00:00:00.0,119.98))
(53926,(2014-06-30 00:00:00.0,119.98))
 */

val orders_join_map= orders_join.map(rec=>rec._2)
//orders_join_map.take(10).foreach(println)
/*
(2014-05-23 00:00:00.0,119.98)
(2014-05-23 00:00:00.0,400.0)
(2014-05-23 00:00:00.0,399.98)
(2014-05-23 00:00:00.0,199.95)
(2014-05-23 00:00:00.0,199.98)
(2013-12-20 00:00:00.0,199.99)
(2013-12-20 00:00:00.0,129.99)
(2014-02-20 00:00:00.0,99.96)
(2014-02-20 00:00:00.0,119.98)
(2014-06-30 00:00:00.0,119.98)
 */
val orders_join_map_gbk = orders_join_map.groupByKey()

//orders_join_map_gbk.take(10).foreach(println)
/*
2013-10-05 00:00:00.0,CompactBuffer(249.9, 119.98, 239.96, 199.95, 159.96, 249.9, 499.95, 179.96, 399.98, 150.0, 250.0, 50.0, 499.95, 239.96, 199.98, 249.9, 299.95, 399.98, 119.98, 49.98, 499.95, 129.99, 119.98, 199.99, 239.96, 149.94, 299.98, 499.95, 199.99, 49.98, 299.98, 129.99, 249.9, 119.98, 164.91, 199.99, 249.9, 129.99, 199.99, 399.98, 399.98, 119.98, 119.98, 179.97, 129.99, 239.96, 299.98, 299.98, 299.98, 299.98, 129.99, 199.99, 129.99, 399.98, 250.0, 39.99, 399.98, 150.0, 104.97, 99.96, 79.98, 239.96, 129.99, 129.99, 239.96, 399.98, 399.96, 299.98, 50.0, 119.97, 129.99, 249.9, 100.0, 250.0, 199.92, 199.99, 129.99, 129.99, 149.94, 99.95, 50.0, 59.99, 99.99, 199.99, 95.97, 399.98, 299.98, 299.98, 199.99, 299.95, 299.98, 191.96, 499.95, 99.96, 59.99, 59.99, 399.98, 100.0, 119.97, 129.99, 159.96, 200.0, 119.98, 399.98, 399.98, 199.99, 119.97, 119.98, 199.98, 299.95, 129.99, 150.0, 44.99, 150.0, 149.94, 399.96, 399.98, 299.95, 104.97, 50.0, 199.98, 399.96, 150.0, 100.0, 179.97, 129.99, 100.0, 399.98, 299.98, 60.0, 179.97, 299.95, 119.98, 129.99, 299.98, 99.96, 199.98, 199.99, 249.9, 100.0, 119.98, 150.0, 150.0, 29.99, 399.96, 149.94, 299.98, 129.99, 66.0, 399.98, 399.96, 199.99, 299.95, 39.99, 239.95, 199.99, 399.98, 249.9, 150.0, 59.99, 65.0, 49.98, 499.95, 59.99, 50.0, 199.99, 50.0, 159.96, 299.98, 60.0, 79.98, 199.99, 399.98, 249.9, 119.98, 129.99, 399.98, 129.99, 24.99, 239.96, 150.0, 200.0, 150.0, 250.0, 55.98, 399.98, 59.99, 249.9, 39.99, 199.98, 250.0, 169.99, 299.98, 129.99, 299.98, 399.98, 129.99, 199.95, 159.96, 159.96, 199.99, 119.97, 129.99, 299.98, 59.99, 200.0, 119.98, 199.99, 199.98, 24.99, 299.98, 50.0, 119.97, 299.98, 99.96))
(2013-08-11 00:00:00.0,CompactBuffer(399.98, 299.99, 399.98, 299.95, 100.0, 99.96, 79.98, 99.99, 129.99, 299.95, 39.99, 50.0, 239.96, 299.95, 199.98, 150.0, 399.96, 399.98, 129.99, 199.99, 119.97, 250.0, 100.0, 149.94, 39.99, 299.97, 39.99, 299.99, 399.98, 239.96, 199.95, 299.98, 399.98, 39.99, 249.9, 199.98, 99.96, 399.98, 50.0, 129.99, 199.98, 150.0, 200.0, 199.99, 199.99, 499.95, 399.98, 119.98, 119.97, 159.96, 150.0, 149.94, 129.99, 129.99, 129.99, 399.98, 99.96, 399.98, 108.0, 159.96, 99.96, 399.98, 399.98, 239.96, 399.96, 299.98, 59.99, 200.0, 399.98, 250.0, 399.98, 399.98, 179.97, 299.97, 299.95, 299.95, 129.99, 399.98, 239.96, 200.0, 199.99, 149.94, 119.97, 129.99, 399.98, 399.98, 199.99, 129.99, 31.98, 79.98, 299.98, 399.98, 59.99, 199.99, 399.98, 59.97, 129.99, 239.96, 129.99, 59.99, 399.98, 159.96, 299.98, 299.98, 95.97, 195.0, 129.99, 59.99, 199.99, 119.98, 199.99, 129.99, 99.96, 149.94, 199.99, 299.98, 129.99, 199.99, 150.0, 59.99, 299.98, 399.98, 179.97, 299.98, 249.9, 179.97, 149.94, 299.95, 119.97, 79.98, 249.9, 49.98, 129.99, 129.99, 249.9, 199.99, 100.0, 129.99, 299.98, 150.0, 191.96, 149.94, 119.98, 191.96, 79.98, 59.99, 499.95, 99.99, 129.99, 199.99, 44.0))
(2013-09-28 00:00:00.0,CompactBuffer(260.0, 399.98, 179.97, 129.99, 50.0, 499.95, 299.98, 250.0, 119.97, 399.98, 129.99, 50.0, 35.98, 129.99, 250.0, 159.96, 399.98, 99.99, 199.99, 127.96, 299.95, 299.95, 119.98, 399.98, 179.97, 399.98, 249.9, 39.99, 129.99, 399.98, 200.0, 239.96, 199.99, 159.99, 119.98, 129.99, 129.99, 200.0, 249.9, 49.98, 129.99, 129.99, 200.0, 50.0, 129.99, 399.98, 149.94, 129.99, 129.99, 499.95, 59.97, 149.94, 199.99, 150.0, 24.99, 129.99, 179.97, 224.95, 149.94, 199.92, 99.99, 150.0, 119.98, 50.0, 199.99, 119.97, 49.95, 399.98, 49.98, 249.9, 129.99, 299.98, 120.0, 199.99, 199.99, 129.99, 39.99, 499.95, 150.0, 299.98, 99.96, 129.99, 199.98, 200.0, 150.0, 39.98, 299.95, 399.98, 129.99, 199.95, 150.0, 199.95, 129.99, 129.99, 219.88, 299.95, 100.0, 149.94, 129.99, 299.98, 199.95, 199.99, 49.98, 299.98, 199.98, 129.99, 299.98, 199.99, 59.99, 39.96, 199.92, 129.99, 100.0, 399.98, 199.92, 129.99, 199.92, 199.99, 399.98, 179.97, 199.99, 129.99, 129.99, 499.95, 299.98, 299.97, 149.94, 199.99, 250.0, 49.98, 399.98, 299.95, 199.92, 124.95, 39.99, 399.98, 149.94, 199.92, 179.97, 99.96, 39.99, 299.95, 199.99, 499.95, 99.99, 95.97, 250.0, 129.99, 199.95, 499.95, 299.98, 199.98, 50.0, 119.97, 59.99, 100.0, 129.99, 50.0, 259.95, 44.99, 399.96, 249.9, 399.98, 129.99, 299.98, 250.0, 169.99, 299.98, 129.99, 79.96, 199.99, 249.9, 59.99, 200.0, 299.97, 399.98, 129.99, 250.0, 199.95, 239.96, 119.98, 299.98))
(2014-06-15 00:00:00.0,CompactBuffer(399.98, 79.98, 99.99, 249.9, 129.99, 200.0, 199.95, 129.99, 59.99, 129.99, 49.98, 199.92, 119.97, 59.99, 299.98, 200.0, 50.0, 199.99, 39.99, 299.95, 99.96, 149.94, 199.92, 199.99, 299.98, 100.0, 119.97, 129.99, 119.98, 129.99, 299.98, 49.98, 155.97, 239.96, 100.0, 199.99, 199.99, 299.98, 299.95, 249.9, 199.92, 129.99, 199.99, 399.98, 199.99, 299.98, 399.98, 119.98, 129.99, 39.99, 150.0, 239.96, 129.99, 119.98, 250.0, 199.92, 49.98, 179.97, 129.99, 179.97, 299.98, 199.99, 150.0, 49.98, 49.98, 399.98, 79.98, 39.99, 399.98, 39.99, 399.98, 199.99, 119.97, 39.99, 299.98, 129.99, 399.98, 199.99, 199.99, 24.99, 199.99, 74.97, 129.99, 499.95, 129.99, 299.98, 39.99, 199.99, 399.98, 199.92, 399.96, 99.99, 129.99, 199.92, 100.0, 129.99, 299.95, 199.95, 129.99, 149.94, 239.96, 150.0, 199.99, 179.97, 129.99, 129.99, 43.98, 129.99, 99.99, 299.95, 250.0, 399.98, 250.0, 299.98, 399.98, 399.98, 129.99, 179.97, 199.95, 59.99, 250.0, 129.99, 299.95, 119.98, 299.98, 129.99, 50.0, 159.96, 179.97, 129.99, 199.99, 179.97, 249.99, 399.98, 399.98, 79.98, 79.98, 199.99))
(2014-05-17 00:00:00.0,CompactBuffer(299.98, 299.98, 299.95, 149.94, 129.99, 379.96, 99.99, 399.98, 249.9, 299.98, 199.99, 150.0, 129.99, 150.0, 399.98, 399.98, 399.96, 129.99, 49.98, 299.98, 39.99, 199.99, 299.98, 299.98, 59.99, 399.98, 149.94, 129.99, 299.98, 150.0, 199.92, 200.0, 150.0, 199.99, 150.0, 350.0, 299.97, 200.0, 399.96, 239.96, 49.98, 129.99, 143.97, 200.0, 79.96, 119.97, 199.92, 50.0, 299.98, 150.0, 499.95, 199.92, 199.99, 159.96, 59.99, 31.99, 299.98, 299.95, 249.9, 199.98, 250.0, 239.96, 100.0, 39.99, 179.97, 199.99, 249.9, 159.96, 149.94, 299.98, 199.99, 24.99, 249.9, 119.98, 399.98, 149.94, 50.0, 200.0, 109.94, 129.99, 149.94, 399.98, 200.0, 159.99, 299.98, 250.0, 99.99, 250.0, 129.99, 299.98, 50.0, 50.0, 200.0, 129.99, 399.98, 199.98, 239.96, 299.98, 200.0, 399.96, 399.96, 54.97, 79.98, 199.99, 399.98, 179.97, 250.0, 59.99, 200.0, 399.98, 189.0, 59.99, 59.99, 129.99, 149.94, 129.99, 119.98, 499.95, 119.98, 39.99, 199.98, 399.98, 399.96, 79.98, 399.98, 199.99, 100.0, 159.96, 299.95, 250.0, 129.99, 239.96, 159.96, 129.99, 129.99, 299.98, 399.98, 199.95, 129.99, 179.97, 200.0, 129.99, 299.98, 299.98, 250.0, 100.0, 179.97, 239.96, 299.98, 499.95, 159.96, 31.99, 129.99, 199.99, 119.97, 150.0, 499.95, 199.98, 349.99, 199.99, 99.96, 299.95, 299.98, 149.94, 129.99, 200.0, 129.99, 129.99, 179.97, 99.99, 129.99, 199.99, 199.92, 129.99, 50.0, 79.98, 399.98, 399.98, 199.99, 124.95, 199.99, 129.99))
(2013-08-08 00:00:00.0,CompactBuffer(474.95, 299.98, 199.99, 95.98, 59.97, 129.99, 47.97, 14.99, 299.97, 50.0, 399.98, 99.96, 299.98, 199.99, 75.0, 49.98, 129.99, 299.97, 399.98, 155.97, 74.97, 200.0, 49.95, 199.99, 95.97, 129.99, 299.98, 299.95, 250.0, 299.95, 99.96, 129.99, 200.0, 199.99, 199.99, 399.98, 129.99, 129.99, 129.99, 249.9, 399.98, 79.96, 499.95, 199.99, 149.94, 129.99, 269.97, 199.99, 39.99, 199.99, 399.98, 129.99, 399.98, 150.0, 299.98, 79.98, 299.95, 199.99, 129.99, 499.95, 50.0, 59.99, 299.98, 199.99, 299.95, 499.95, 399.98, 299.98, 50.0, 129.99, 299.95, 50.0, 299.98, 150.0, 200.0, 100.0, 129.99, 179.97, 119.97, 150.0, 399.98, 239.96, 50.0, 249.9, 99.99, 159.99, 129.99, 239.96, 50.0, 179.96, 199.99, 399.96, 129.99, 399.98, 249.99, 399.96, 399.98, 210.0, 199.99, 299.95, 129.99, 49.98, 239.96, 129.99, 129.99, 50.0, 199.99, 200.0, 159.96, 129.99, 129.99, 129.99, 179.97, 140.0, 199.99, 200.0, 299.99, 399.98, 150.0, 200.0, 99.96, 70.0, 39.99, 399.98, 399.98, 63.98, 150.0, 50.0, 299.98, 99.96, 69.98, 66.0, 159.96, 29.98, 79.98, 104.97, 129.99, 129.99, 250.0, 179.97, 179.97, 199.95, 199.92, 129.99, 129.99, 199.95, 199.99, 199.99, 59.99, 99.96, 179.97, 399.98, 150.0, 207.96, 43.98, 299.98, 299.95, 159.96, 299.95, 399.98, 59.99, 49.98, 119.98, 299.98, 399.96, 100.0, 150.0, 399.98, 129.99, 399.98, 99.96))
(2014-07-24 00:00:00.0,CompactBuffer(399.98, 59.99, 199.95, 129.99, 129.99, 59.99, 199.98, 200.0, 399.98, 399.98, 119.98, 59.99, 399.98, 129.99, 129.99, 399.95, 79.98, 399.98, 50.0, 399.98, 399.98, 179.97, 239.96, 239.96, 199.98, 250.0, 200.0, 127.96, 149.94, 31.98, 100.0, 129.99, 239.96, 199.99, 299.98, 249.9, 239.96, 99.99, 299.98, 39.98, 129.99, 199.99, 30.0, 399.98, 199.99, 129.99, 199.99, 199.99, 239.96, 129.99, 199.98, 299.98, 39.99, 399.98, 139.95, 299.98, 149.94, 159.96, 499.95, 199.95, 399.96, 79.98, 179.97, 49.98, 299.98, 199.95, 129.99, 399.98, 39.98, 200.0, 99.99, 299.95, 79.98, 129.99, 250.0, 99.96, 399.96, 74.97, 50.0, 399.98, 19.99, 119.98, 179.97, 100.0, 129.99, 39.99, 199.99, 89.99, 269.97, 129.99, 59.99, 299.97, 129.99, 299.95, 199.99, 50.0, 179.97, 199.99, 199.99, 250.0, 299.95, 149.94, 200.0, 399.98, 129.99, 79.98, 199.98, 129.99, 129.99, 399.98, 199.99, 50.0, 100.0, 299.98, 499.95, 179.97, 399.98, 299.98, 159.96, 299.98, 149.94, 299.98, 239.95, 99.99, 179.97, 399.98, 50.0, 399.98, 129.99, 79.98, 299.98, 199.99, 250.0, 299.97, 199.99, 299.98, 199.99, 399.96, 299.95, 299.95, 149.94, 249.9, 90.0, 129.99, 199.95, 250.0, 50.0, 399.98, 399.98, 239.96, 199.98, 299.95, 44.97, 179.97, 179.97, 199.99, 199.99, 299.98, 199.98, 299.98, 129.99, 50.0, 149.94, 199.99, 299.95, 129.99, 79.98, 100.0, 14.99, 399.96, 24.99, 399.98, 129.99, 124.99, 50.0, 199.98, 79.98, 179.97, 129.99, 199.99, 159.96, 299.97, 43.98, 129.99, 399.96, 299.98, 149.94, 100.0, 50.0, 499.95, 129.99, 99.96, 35.98, 399.98, 299.97, 100.0, 129.99, 129.99, 299.95, 129.99, 239.96, 179.97, 299.98, 29.98, 150.0, 129.99, 299.98, 99.96, 49.98, 149.94, 120.0, 299.98, 119.97, 249.9, 129.99, 119.97, 200.0, 74.97, 159.96, 399.98, 50.0, 49.98, 174.95, 99.96, 250.0, 199.99, 179.97, 199.99, 399.98, 59.99, 199.99, 159.99, 129.99, 31.99, 299.98, 399.98, 399.98, 399.96, 239.96, 239.96, 99.96, 199.99, 199.92, 79.98, 150.0, 239.96, 199.98, 399.98, 59.99, 129.99, 149.94, 119.98, 63.98, 399.98, 129.99, 59.99, 129.99, 199.92, 50.0))
(2014-04-17 00:00:00.0,CompactBuffer(199.99, 199.99, 499.95, 199.92, 129.99, 199.92, 79.98, 299.98, 200.0, 399.98, 49.98, 129.99, 299.97, 99.96, 199.99, 59.99, 59.99, 499.95, 50.0, 129.99, 199.95, 129.99, 199.99, 150.0, 239.96, 179.97, 399.98, 119.97, 399.98, 299.95, 159.96, 99.96, 31.99, 399.98, 129.99, 299.98, 249.9, 199.92, 399.98, 99.99, 299.95, 299.95, 399.98, 399.98, 59.99, 399.98, 200.0, 149.94, 199.99, 200.0, 59.99, 199.99, 299.95, 399.98, 129.99, 129.99, 159.96, 150.0, 199.99, 149.94, 31.99, 199.99, 179.97, 199.92, 149.94, 119.98, 129.99, 499.95, 399.98, 239.96, 109.99, 199.92, 49.98, 399.98, 99.96, 399.98, 199.98, 250.0, 239.96, 129.99, 129.99, 59.99, 150.0, 199.99, 129.99, 159.96, 399.98, 129.99, 79.98, 299.98, 199.99, 299.95, 59.99, 179.97, 90.0, 199.92, 239.96, 299.98, 100.0, 399.98, 399.98, 129.99, 249.9, 119.98, 129.99, 299.98, 199.98, 299.98, 59.99))
(2014-05-23 00:00:00.0,CompactBuffer(119.98, 400.0, 399.98, 199.95, 199.98, 100.0, 179.97, 119.98, 99.96, 119.98, 129.99, 239.96, 299.98, 199.98, 499.95, 129.99, 199.99, 399.98, 239.96, 299.95, 50.0, 99.96, 129.99, 150.0, 59.99, 159.96, 14.99, 199.99, 129.99, 129.99, 119.98, 299.98, 239.96, 159.96, 199.99, 129.99, 150.0, 50.0, 39.99, 250.0, 139.96, 199.99, 299.98, 199.99, 129.99, 299.98, 199.99, 39.99, 399.98, 239.96, 129.99, 199.99, 99.99, 49.98, 399.96, 199.98, 129.99, 100.0, 179.97, 129.99, 499.95, 399.96, 299.98, 299.98, 249.9, 249.9, 199.92, 129.99, 79.98, 129.99, 399.96, 199.99, 200.0, 129.99, 59.99, 199.99, 129.99, 199.95, 299.98, 199.99, 299.95, 99.96, 399.98, 200.0, 399.98, 50.0, 399.98, 299.95, 119.98, 119.98, 50.0, 239.96, 159.96, 119.98, 299.98, 239.96, 149.94, 59.99, 100.0, 179.97, 99.99, 249.9, 199.99, 199.92, 119.97, 100.0, 149.94, 159.96, 59.99, 200.0, 119.98, 199.99, 199.92, 100.0, 100.0, 150.0, 150.0, 299.98, 299.98, 179.97, 199.92, 399.98, 299.98, 100.0, 129.99, 129.99, 199.95, 499.95, 199.99, 399.96, 50.0, 199.99, 299.97, 119.97, 149.94, 399.98, 100.0, 399.98, 39.99, 90.0, 119.98, 119.96, 150.0, 95.97, 24.99, 129.99, 49.98, 299.98, 29.99, 59.99, 199.92, 129.99, 399.98, 299.98, 50.0, 199.99, 200.0, 399.98, 299.98, 50.0, 250.0, 199.92, 199.99, 499.95, 59.99, 299.98, 129.99, 129.99, 199.95))
(2014-01-23 00:00:00.0,CompactBuffer(200.0, 129.99, 129.99, 199.99, 399.98, 99.96, 129.99, 119.98, 59.99, 199.00))
 */
val final_output= orders_join_map_gbk.map(rec=>(rec._1,rec._2.sum))
final_output.take(10).foreach(println)


